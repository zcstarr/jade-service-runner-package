"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
var ajv_1 = __importDefault(require("ajv"));
var _ = __importStar(require("lodash"));
var generate_method_id_1 = require("../generate-method-id");
var parameter_validation_error_1 = require("./parameter-validation-error");
var MethodCallValidator = /** @class */ (function () {
    function MethodCallValidator(schema) {
        var _this = this;
        this.schema = schema;
        this.ajvValidator = new ajv_1.default();
        schema.methods.forEach(function (method) {
            var params = method.params;
            if (method.params === undefined) {
                return;
            }
            params.forEach(function (param, i) {
                if (param.schema === undefined) {
                    return;
                }
                _this.ajvValidator.addSchema(param.schema, generate_method_id_1.generateMethodParamId(method, param));
            });
        });
    }
    MethodCallValidator.prototype.validate = function (methodName, params) {
        var _this = this;
        var method = _.find(this.schema.methods, { name: methodName });
        if (method.params === undefined) {
            return [];
        }
        return _.chain(method.params)
            .map(function (param, index) {
            if (param.schema === undefined) {
                return;
            }
            var idForMethod = generate_method_id_1.generateMethodParamId(method, param);
            var isValid = _this.ajvValidator.validate(idForMethod, params[index]);
            var errors = _this.ajvValidator.errors;
            if (!isValid) {
                return new parameter_validation_error_1.ParameterValidationError(index, param.schema, params[index], errors);
            }
        })
            .compact()
            .value();
    };
    return MethodCallValidator;
}());
exports.MethodCallValidator = MethodCallValidator;
